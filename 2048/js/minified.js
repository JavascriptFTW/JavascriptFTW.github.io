function changeFavicon(e){var t=document.getElementById("favicon");t.href=e,t.id="favicon"}function toggleClass(e,t){"night"===e&&changeFavicon(modeStates[e]?"favicon.ico":"night-favicon.ico"),void 0===t&&(t=document.getElementsByTagName("*")),t.length||(t=[t]),modeStates[e]=!modeStates[e];for(var a="",o=0;o<e.length;o++)a+=o<e.length-1?e.substr(o,1)+"+":e.substr(o,1);for(var i=new RegExp(a,"m"),o=0;o<t.length;o++){var n=t[o],s=n.className,r=s.indexOf(e);-1!==r&&(s=s.replace(i,"")),modeStates[e]&&(s+=" "+e),s.trim(),n.className=s}}function addClasses(e){for(var t=e.className,a=0;a<modes.length;a++)modeStates[modes[a]]&&(t+=" "+modes[a]);t.trim(),e.className=t}function hasClass(e,t){return-1!==e.className.indexOf(t)}function KeyboardInputManager(){this.events={},window.navigator.msPointerEnabled?(this.eventTouchstart="MSPointerDown",this.eventTouchmove="MSPointerMove",this.eventTouchend="MSPointerUp"):(this.eventTouchstart="touchstart",this.eventTouchmove="touchmove",this.eventTouchend="touchend"),this.listen()}function HTMLActuator(){this.tileContainer=document.querySelector(".tile-container"),this.scoreContainer=document.querySelector(".score-container"),this.bestContainer=document.querySelector(".best-container"),this.messageContainer=document.querySelector(".game-message"),this.score=0}function Grid(e,t){this.size=e,this.cells=t?this.fromState(t):this.empty()}function LocalStorageManager(){this.bestScoreKey="bestScore",this.gameStateKey="gameState",this.bookmarksKey="bookmarks",this.bookmarks={},this.bookmarkKeys=[],this.bookMarksLoaded=!1;var e=this.localStorageSupported();this.storage=e?window.localStorage:window.fakeStorage}function GameManager(e,t,a,o,i){this.size=e,this.inputManager=new t,this.storageManager=new o,this.actuator=new a,this.popupManager=new i(this),this.startTiles=2,this.inputManager.on("move",this.move.bind(this)),this.inputManager.on("restart",this.confirmRestart.bind(this)),this.inputManager.on("keepPlaying",this.keepPlaying.bind(this)),this.inputManager.on("save",this.saveState.bind(this)),this.inputManager.on("load",this.loadState.bind(this)),this.setup()}var modeStates={},modes=[];Function.prototype.bind=Function.prototype.bind||function(e){var t=this;return function(a){a instanceof Array||(a=[a]),t.apply(e,a)}},function(){function e(e){this.el=e;for(var t=e.className.replace(/^\s+|\s+$/g,"").split(/\s+/),a=0;a<t.length;a++)o.call(this,t[a])}function t(e,t,a){Object.defineProperty?Object.defineProperty(e,t,{get:a}):e.__defineGetter__(t,a)}if(!("undefined"==typeof window.Element||"classList"in document.documentElement)){var a=Array.prototype,o=a.push,i=a.splice,n=a.join;e.prototype={add:function(e){this.contains(e)||(o.call(this,e),this.el.className=this.toString())},contains:function(e){return-1!=this.el.className.indexOf(e)},item:function(e){return this[e]||null},remove:function(e){if(this.contains(e)){for(var t=0;t<this.length&&this[t]!=e;t++);i.call(this,t,1),this.el.className=this.toString()}},toString:function(){return n.call(this," ")},toggle:function(e){return this.contains(e)?this.remove(e):this.add(e),this.contains(e)}},window.DOMTokenList=e,t(HTMLElement.prototype,"classList",function(){return new e(this)})}}(),function(){for(var e=0,t=["webkit","moz"],a=0;a<t.length&&!window.requestAnimationFrame;++a)window.requestAnimationFrame=window[t[a]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[a]+"CancelAnimationFrame"]||window[t[a]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t){var a=(new Date).getTime(),o=Math.max(0,16-(a-e)),i=window.setTimeout(function(){t(a+o)},o);return e=a+o,i}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),KeyboardInputManager.prototype.on=function(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)},KeyboardInputManager.prototype.emit=function(e,t){var a=this.events[e];a&&a.forEach(function(e){e(t)})},KeyboardInputManager.prototype.listen=function(){var e=this,t={38:0,39:1,40:2,37:3,75:0,76:1,74:2,72:3,87:0,68:1,83:2,65:3};document.addEventListener("keydown",function(a){var o=a.altKey||a.ctrlKey||a.metaKey||a.shiftKey,i=t[a.which],n=a.target||a.srcElement,s=1==n.nodeType?n.nodeName.toUpperCase():"",r=document.getElementById("overlay");o||/INPUT|SELECT|TEXTAREA/.test(s)||(void 0!==i&&-1!==r.className.indexOf("hidden")?(a.preventDefault(),e.emit("move",i),o||82!==a.which||e.restart.call(e,a)):a.preventDefault())}),this.bindButtonPress(".retry-button",this.restart),this.bindButtonPress(".restart-button",this.restart),this.bindButtonPress(".keep-playing-button",this.keepPlaying),this.bindButtonPress("#save",this.save),this.bindButtonPress("#load",this.load);var a,o,i=document.getElementsByClassName("game-container")[0];i.addEventListener(this.eventTouchstart,function(e){!window.navigator.msPointerEnabled&&e.touches.length>1||e.targetTouches>1||(window.navigator.msPointerEnabled?(a=e.pageX,o=e.pageY):(a=e.touches[0].clientX,o=e.touches[0].clientY),e.preventDefault())}),i.addEventListener(this.eventTouchmove,function(e){e.preventDefault()}),i.addEventListener(this.eventTouchend,function(t){if(!(!window.navigator.msPointerEnabled&&t.touches.length>0||t.targetTouches>0)){var i,n;window.navigator.msPointerEnabled?(i=t.pageX,n=t.pageY):(i=t.changedTouches[0].clientX,n=t.changedTouches[0].clientY);var s=i-a,r=Math.abs(s),l=n-o,p=Math.abs(l);Math.max(r,p)>10&&e.emit("move",r>p?s>0?1:3:l>0?2:0)}})},KeyboardInputManager.prototype.restart=function(e){e.preventDefault(),this.emit("restart")},KeyboardInputManager.prototype.keepPlaying=function(e){e.preventDefault(),this.emit("keepPlaying")},KeyboardInputManager.prototype.save=function(e){e.preventDefault(),this.emit("save")},KeyboardInputManager.prototype.load=function(e){e.preventDefault(),this.emit("load")},KeyboardInputManager.prototype.bindButtonPress=function(e,t){var a=document.querySelector(e);a.addEventListener("click",t.bind(this)),a.addEventListener(this.eventTouchend,t.bind(this))},HTMLActuator.prototype.actuate=function(e,t){var a=this;window.requestAnimationFrame(function(){a.clearContainer(a.tileContainer),e.cells.forEach(function(e){e.forEach(function(e){e&&a.addTile(e)})}),a.updateScore(t.score),a.updateBestScore(t.bestScore),t.terminated&&(t.over?a.message(!1):t.won&&a.message(!0))})},HTMLActuator.prototype.continueGame=function(){this.clearMessage()},HTMLActuator.prototype.clearContainer=function(e){for(;e.firstChild;)e.removeChild(e.firstChild)},HTMLActuator.prototype.addTile=function(e){var t=this,a=document.createElement("div"),o=document.createElement("div"),i=e.previousPosition||{x:e.x,y:e.y},n=this.positionClass(i),s=["tile","tile-"+e.value,n];e.value>2048&&s.push("tile-super");for(var r=0;r<modes.length;r++)modeStates[modes[r]]&&s.push(modes[r]);this.applyClasses(a,s),o.classList.add("tile-inner"),o.textContent=e.value,e.previousPosition?window.requestAnimationFrame(function(){s[2]=t.positionClass({x:e.x,y:e.y}),t.applyClasses(a,s)}):e.mergedFrom?(s.push("tile-merged"),this.applyClasses(a,s),e.mergedFrom.forEach(function(e){t.addTile(e)})):(s.push("tile-new"),this.applyClasses(a,s)),a.appendChild(o),this.tileContainer.appendChild(a)},HTMLActuator.prototype.applyClasses=function(e,t){e.setAttribute("class",t.join(" "))},HTMLActuator.prototype.normalizePosition=function(e){return{x:e.x+1,y:e.y+1}},HTMLActuator.prototype.positionClass=function(e){return e=this.normalizePosition(e),"tile-position-"+e.x+"-"+e.y},HTMLActuator.prototype.updateScore=function(e){this.clearContainer(this.scoreContainer);var t=e-this.score;if(this.score=e,this.scoreContainer.textContent=this.score,t>0){var a=document.createElement("div");a.classList.add("score-addition"),addClasses(a),a.textContent="+"+t,a.addEventListener("animationend",function(){this.parentNode.removeChild(a)}),this.scoreContainer.appendChild(a)}},HTMLActuator.prototype.updateBestScore=function(e){this.bestContainer.textContent=e},HTMLActuator.prototype.message=function(e){var t=e?"game-won":"game-over",a=e?"You win!":"Game over!";this.messageContainer.classList.add(t),this.messageContainer.getElementsByTagName("p")[0].textContent=a},HTMLActuator.prototype.clearMessage=function(){this.messageContainer.classList.remove("game-won"),this.messageContainer.classList.remove("game-over")},Grid.prototype.empty=function(){for(var e=[],t=0;t<this.size;t++)for(var a=e[t]=[],o=0;o<this.size;o++)a.push(null);return e},Grid.prototype.fromState=function(e){for(var t=[],a=0;a<this.size;a++)for(var o=t[a]=[],i=0;i<this.size;i++){var n=e[a][i];o.push(n?new Tile(n.position,n.value):null)}return t},Grid.prototype.randomAvailableCell=function(){var e=this.availableCells();return e.length?e[Math.floor(Math.random()*e.length)]:void 0},Grid.prototype.availableCells=function(){var e=[];return this.eachCell(function(t,a,o){o||e.push({x:t,y:a})}),e},Grid.prototype.eachCell=function(e){for(var t=0;t<this.size;t++)for(var a=0;a<this.size;a++)e(t,a,this.cells[t][a])},Grid.prototype.cellsAvailable=function(){return!!this.availableCells().length},Grid.prototype.cellAvailable=function(e){return!this.cellOccupied(e)},Grid.prototype.cellOccupied=function(e){return!!this.cellContent(e)},Grid.prototype.cellContent=function(e){return this.withinBounds(e)?this.cells[e.x][e.y]:null},Grid.prototype.insertTile=function(e){this.cells[e.x][e.y]=e},Grid.prototype.removeTile=function(e){this.cells[e.x][e.y]=null},Grid.prototype.withinBounds=function(e){return e.x>=0&&e.x<this.size&&e.y>=0&&e.y<this.size},Grid.prototype.serialize=function(){for(var e=[],t=0;t<this.size;t++)for(var a=e[t]=[],o=0;o<this.size;o++)a.push(this.cells[t][o]?this.cells[t][o].serialize():null);return{size:this.size,cells:e}},window.fakeStorage={_data:{},setItem:function(e,t){return this._data[e]=String(t)},getItem:function(e){return this._data.hasOwnProperty(e)?this._data[e]:void 0},removeItem:function(e){return delete this._data[e]},clear:function(){return this._data={}}},LocalStorageManager.prototype.localStorageSupported=function(){var e="test",t=window.localStorage;try{return t.setItem(e,"1"),t.removeItem(e),!0}catch(a){return!1}},LocalStorageManager.prototype.getBestScore=function(){return this.storage.getItem(this.bestScoreKey)||0},LocalStorageManager.prototype.setBestScore=function(e){this.storage.setItem(this.bestScoreKey,e)},LocalStorageManager.prototype.getGameState=function(){var e=this.storage.getItem(this.gameStateKey);return e?JSON.parse(e):null},LocalStorageManager.prototype.setGameState=function(e){this.storage.setItem(this.gameStateKey,JSON.stringify(e))},LocalStorageManager.prototype.clearGameState=function(){this.storage.removeItem(this.gameStateKey)},LocalStorageManager.prototype.loadBookmarks=function(){if(!this.bookmarksLoaded){var e=this.storage.getItem(this.bookmarksKey);this.bookmarks=e?JSON.parse(e):{};for(var t in this.bookmarks)this.bookmarkKeys.push(t)}this.bookmarksLoaded=!0},LocalStorageManager.prototype.syncBookmarks=function(){this.storage.setItem(this.bookmarksKey,JSON.stringify(this.bookmarks))},LocalStorageManager.prototype.addBookmark=function(e,t){this.bookmarks[e]=JSON.stringify(t),-1===this.bookmarkKeys.indexOf(e)&&this.bookmarkKeys.push(e),this.syncBookmarks()},LocalStorageManager.prototype.loadBookmark=function(e){return JSON.parse(this.bookmarks[e])},LocalStorageManager.prototype.deleteBookmark=function(e){delete this.bookmarks[e],this.bookmarkKeys.splice(this.bookmarkKeys.indexOf(e),1),this.syncBookmarks()},GameManager.prototype.refreshBookmarks=function(){this.storageManager.loadBookmarks();for(var e=function(e){this.popupManager.popups.loadKey.value=e.target.textContent;var t=this.popupManager.popups.load.getElementsByClassName("yes")[0];hasClass(t,"no-click")&&toggleClass("no-click",t)}.bind(this),t=function(e){this.popupManager.popups.saveAs.value=e.target.textContent;var t=this.popupManager.popups.prompt.getElementsByClassName("yes")[0];hasClass(t,"no-click")&&toggleClass("no-click",t)}.bind(this),a=this.storageManager.bookmarkKeys,o=document.getElementsByClassName("bookmark-container"),i=0;i<o.length;i++){var n=o[i];n.innerHTML="";for(var s=0;s<a.length;s++){var r=a[s],l=document.createElement("a");l.innerHTML=r+"<br>",l.onclick="load-popup"===o[i].parentNode.id?e:t,n.appendChild(l)}}this.loaded=!0},GameManager.prototype.saveState=function(){this.popupManager.activate("prompt"),this.refreshBookmarks()},GameManager.prototype.loadState=function(){this.refreshBookmarks(),this.popupManager.activate("load")},GameManager.prototype.restart=function(){this.storageManager.clearGameState(),this.actuator.continueGame(),this.setup()},GameManager.prototype.confirmRestart=function(){this.popupManager.activate("confirm")},GameManager.prototype.keepPlaying=function(){this.keepPlaying=!0,this.actuator.continueGame()},GameManager.prototype.isGameTerminated=function(){return this.over||this.won&&!this.keepPlaying},GameManager.prototype.setState=function(e){this.grid=new Grid(e.grid.size,e.grid.cells),this.score=e.score,this.over=e.over,this.won=e.won,this.keepPlaying=e.keepPlaying,this.actuate()},GameManager.prototype.setup=function(){var e=this.storageManager.getGameState();return e?void this.setState(e):(this.grid=new Grid(this.size),this.score=0,this.over=!1,this.won=!1,this.keepPlaying=!1,this.addStartTiles(),void this.actuate())},GameManager.prototype.addStartTiles=function(){for(var e=0;e<this.startTiles;e++)this.addRandomTile()},GameManager.prototype.addRandomTile=function(){if(this.grid.cellsAvailable()){var e=Math.random()<.9?2:4,t=new Tile(this.grid.randomAvailableCell(),e);this.grid.insertTile(t)}},GameManager.prototype.actuate=function(){this.storageManager.getBestScore()<this.score&&this.storageManager.setBestScore(this.score),this.over?this.storageManager.clearGameState():this.storageManager.setGameState(this.serialize()),this.actuator.actuate(this.grid,{score:this.score,over:this.over,won:this.won,bestScore:this.storageManager.getBestScore(),terminated:this.isGameTerminated()})},GameManager.prototype.serialize=function(){return{grid:this.grid.serialize(),score:this.score,over:this.over,won:this.won,keepPlaying:this.keepPlaying}},GameManager.prototype.prepareTiles=function(){this.grid.eachCell(function(e,t,a){a&&(a.mergedFrom=null,a.savePosition())})},GameManager.prototype.moveTile=function(e,t){this.grid.cells[e.x][e.y]=null,this.grid.cells[t.x][t.y]=e,e.updatePosition(t)},GameManager.prototype.move=function(e){var t=this;if(!this.isGameTerminated()){var a,o,i=this.getVector(e),n=this.buildTraversals(i),s=!1;this.prepareTiles(),n.x.forEach(function(e){n.y.forEach(function(n){if(a={x:e,y:n},o=t.grid.cellContent(a)){var r=t.findFarthestPosition(a,i),l=t.grid.cellContent(r.next);if(l&&l.value===o.value&&!l.mergedFrom){var p=new Tile(r.next,2*o.value);p.mergedFrom=[o,l],t.grid.insertTile(p),t.grid.removeTile(o),o.updatePosition(r.next),t.score+=p.value,2048===p.value&&(t.won=!0)}else t.moveTile(o,r.farthest);t.positionsEqual(a,o)||(s=!0)}})}),s&&(this.addRandomTile(),this.movesAvailable()||(this.over=!0),this.actuate())}},GameManager.prototype.getVector=function(e){var t={0:{x:0,y:-1},1:{x:1,y:0},2:{x:0,y:1},3:{x:-1,y:0}};return t[e]},GameManager.prototype.buildTraversals=function(e){for(var t={x:[],y:[]},a=0;a<this.size;a++)t.x.push(a),t.y.push(a);return 1===e.x&&(t.x=t.x.reverse()),1===e.y&&(t.y=t.y.reverse()),t},GameManager.prototype.findFarthestPosition=function(e,t){var a;do a=e,e={x:a.x+t.x,y:a.y+t.y};while(this.grid.withinBounds(e)&&this.grid.cellAvailable(e));return{farthest:a,next:e}},GameManager.prototype.movesAvailable=function(){return this.grid.cellsAvailable()||this.tileMatchesAvailable()},GameManager.prototype.tileMatchesAvailable=function(){for(var e,t=this,a=0;a<this.size;a++)for(var o=0;o<this.size;o++)if(e=this.grid.cellContent({x:a,y:o}))for(var i=0;4>i;i++){var n=t.getVector(i),s={x:a+n.x,y:o+n.y},r=t.grid.cellContent(s);if(r&&r.value===e.value)return!0}return!1},GameManager.prototype.positionsEqual=function(e,t){return e.x===t.x&&e.y===t.y};var PopupManager=function(e){this.gameManager=e,this.popups={overlay:document.getElementById("overlay"),confirm:document.getElementById("confirm"),prompt:document.getElementById("prompt"),load:document.getElementById("load-popup"),saveAs:document.getElementById("save-as"),loadKey:document.getElementById("load-key"),active:null},toggleClass("hidden",[this.popups.confirm,this.popups.prompt,this.popups.overlay,this.popups.load]),this.terminators={alert:function(){popups.result=!0}.bind(this),confirm:function(e){e&&this.gameManager.restart()}.bind(this),prompt:function(e){e&&this.gameManager.storageManager.addBookmark(this.popups.saveAs.value,this.gameManager.storageManager.getGameState()),this.popups.saveAs.value=""}.bind(this),"load-popup":function(e){e&&this.gameManager.setState(this.gameManager.storageManager.loadBookmark(this.popups.loadKey.value))}.bind(this)},this.popups.saveAs.value="",this.popups.loadKey.value="";for(var t=this.popups.overlay.getElementsByClassName("yes"),a=0;a<t.length;a++)t[a].addEventListener("click",function(e){hasClass(e.target,"no-click")||this.terminate(!0)}.bind(this));for(var o=this.popups.overlay.getElementsByClassName("no"),a=0;a<o.length;a++)o[a].addEventListener("click",function(){this.terminate(!1)}.bind(this));toggleClass("no-click",this.popups.prompt.getElementsByClassName("yes")[0]),this.popups.saveAs.addEventListener("input",function(){var e=this.popups.prompt.getElementsByClassName("yes")[0],t=hasClass(e,"no-click");this.popups.saveAs.value.length>0&&t?toggleClass("no-click",e):0!==this.popups.saveAs.value.length||t||toggleClass("no-click",e)}.bind(this)),this.popups.loadKey.addEventListener("input",function(){var e=this.popups.load.getElementsByClassName("yes")[0],t=hasClass(e,"no-click");-1!==this.gameManager.storageManager.bookmarkKeys.indexOf(this.popups.loadKey.value)&&t?toggleClass("no-click",e):t||toggleClass("no-click",e)}.bind(this))};PopupManager.prototype.activate=function(e){this.popups.active=this.popups[e],"prompt"===e&&this.popups.saveAs.focus();var t=this.popups.active;toggleClass("hidden",[t,this.popups.overlay])},PopupManager.prototype.terminate=function(e){toggleClass("hidden",[this.popups.overlay,this.popups.active]),this.terminators[this.popups.active.id](e),this.popups.active=null},window.requestAnimationFrame(function(){new GameManager(4,KeyboardInputManager,HTMLActuator,LocalStorageManager,PopupManager)});function changeFavicon(e){var t=document.getElementById("favicon");t.href=e,t.id="favicon"}function toggleClass(e,t){"night"===e&&changeFavicon(modeStates[e]?"favicon.ico":"night-favicon.ico"),void 0===t&&(t=document.getElementsByTagName("*")),t.length||(t=[t]),modeStates[e]=!modeStates[e];for(var a="",o=0;o<e.length;o++)a+=o<e.length-1?e.substr(o,1)+"+":e.substr(o,1);for(var i=new RegExp(a,"m"),o=0;o<t.length;o++){var n=t[o],s=n.className,r=s.indexOf(e);-1!==r&&(s=s.replace(i,"")),modeStates[e]&&(s+=" "+e),s.trim(),n.className=s}}function addClasses(e){for(var t=e.className,a=0;a<modes.length;a++)modeStates[modes[a]]&&(t+=" "+modes[a]);t.trim(),e.className=t}function hasClass(e,t){return-1!==e.className.indexOf(t)}function KeyboardInputManager(){this.events={},window.navigator.msPointerEnabled?(this.eventTouchstart="MSPointerDown",this.eventTouchmove="MSPointerMove",this.eventTouchend="MSPointerUp"):(this.eventTouchstart="touchstart",this.eventTouchmove="touchmove",this.eventTouchend="touchend"),this.listen()}function HTMLActuator(){this.tileContainer=document.querySelector(".tile-container"),this.scoreContainer=document.querySelector(".score-container"),this.bestContainer=document.querySelector(".best-container"),this.messageContainer=document.querySelector(".game-message"),this.score=0}function Grid(e,t){this.size=e,this.cells=t?this.fromState(t):this.empty()}function LocalStorageManager(){this.bestScoreKey="bestScore",this.gameStateKey="gameState",this.bookmarksKey="bookmarks",this.bookmarks={},this.bookmarkKeys=[],this.bookMarksLoaded=!1;var e=this.localStorageSupported();this.storage=e?window.localStorage:window.fakeStorage}function GameManager(e,t,a,o,i){this.size=e,this.inputManager=new t,this.storageManager=new o,this.actuator=new a,this.popupManager=new i(this),this.startTiles=2,this.inputManager.on("move",this.move.bind(this)),this.inputManager.on("restart",this.confirmRestart.bind(this)),this.inputManager.on("keepPlaying",this.keepPlaying.bind(this)),this.inputManager.on("save",this.saveState.bind(this)),this.inputManager.on("load",this.loadState.bind(this)),this.setup()}var modeStates={},modes=[];Function.prototype.bind=Function.prototype.bind||function(e){var t=this;return function(a){a instanceof Array||(a=[a]),t.apply(e,a)}},function(){function e(e){this.el=e;for(var t=e.className.replace(/^\s+|\s+$/g,"").split(/\s+/),a=0;a<t.length;a++)o.call(this,t[a])}function t(e,t,a){Object.defineProperty?Object.defineProperty(e,t,{get:a}):e.__defineGetter__(t,a)}if(!("undefined"==typeof window.Element||"classList"in document.documentElement)){var a=Array.prototype,o=a.push,i=a.splice,n=a.join;e.prototype={add:function(e){this.contains(e)||(o.call(this,e),this.el.className=this.toString())},contains:function(e){return-1!=this.el.className.indexOf(e)},item:function(e){return this[e]||null},remove:function(e){if(this.contains(e)){for(var t=0;t<this.length&&this[t]!=e;t++);i.call(this,t,1),this.el.className=this.toString()}},toString:function(){return n.call(this," ")},toggle:function(e){return this.contains(e)?this.remove(e):this.add(e),this.contains(e)}},window.DOMTokenList=e,t(HTMLElement.prototype,"classList",function(){return new e(this)})}}(),function(){for(var e=0,t=["webkit","moz"],a=0;a<t.length&&!window.requestAnimationFrame;++a)window.requestAnimationFrame=window[t[a]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[a]+"CancelAnimationFrame"]||window[t[a]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t){var a=(new Date).getTime(),o=Math.max(0,16-(a-e)),i=window.setTimeout(function(){t(a+o)},o);return e=a+o,i}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),KeyboardInputManager.prototype.on=function(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)},KeyboardInputManager.prototype.emit=function(e,t){var a=this.events[e];a&&a.forEach(function(e){e(t)})},KeyboardInputManager.prototype.listen=function(){var e=this,t={38:0,39:1,40:2,37:3,75:0,76:1,74:2,72:3,87:0,68:1,83:2,65:3};document.addEventListener("keydown",function(a){var o=a.altKey||a.ctrlKey||a.metaKey||a.shiftKey,i=t[a.which],n=a.target||a.srcElement,s=1==n.nodeType?n.nodeName.toUpperCase():"",r=document.getElementById("overlay");o||/INPUT|SELECT|TEXTAREA/.test(s)||(void 0!==i&&-1!==r.className.indexOf("hidden")?(a.preventDefault(),e.emit("move",i),o||82!==a.which||e.restart.call(e,a)):a.preventDefault())}),this.bindButtonPress(".retry-button",this.restart),this.bindButtonPress(".restart-button",this.restart),this.bindButtonPress(".keep-playing-button",this.keepPlaying),this.bindButtonPress("#save",this.save),this.bindButtonPress("#load",this.load);var a,o,i=document.getElementsByClassName("game-container")[0];i.addEventListener(this.eventTouchstart,function(e){!window.navigator.msPointerEnabled&&e.touches.length>1||e.targetTouches>1||(window.navigator.msPointerEnabled?(a=e.pageX,o=e.pageY):(a=e.touches[0].clientX,o=e.touches[0].clientY),e.preventDefault())}),i.addEventListener(this.eventTouchmove,function(e){e.preventDefault()}),i.addEventListener(this.eventTouchend,function(t){if(!(!window.navigator.msPointerEnabled&&t.touches.length>0||t.targetTouches>0)){var i,n;window.navigator.msPointerEnabled?(i=t.pageX,n=t.pageY):(i=t.changedTouches[0].clientX,n=t.changedTouches[0].clientY);var s=i-a,r=Math.abs(s),l=n-o,p=Math.abs(l);Math.max(r,p)>10&&e.emit("move",r>p?s>0?1:3:l>0?2:0)}})},KeyboardInputManager.prototype.restart=function(e){e.preventDefault(),this.emit("restart")},KeyboardInputManager.prototype.keepPlaying=function(e){e.preventDefault(),this.emit("keepPlaying")},KeyboardInputManager.prototype.save=function(e){e.preventDefault(),this.emit("save")},KeyboardInputManager.prototype.load=function(e){e.preventDefault(),this.emit("load")},KeyboardInputManager.prototype.bindButtonPress=function(e,t){var a=document.querySelector(e);a.addEventListener("click",t.bind(this)),a.addEventListener(this.eventTouchend,t.bind(this))},HTMLActuator.prototype.actuate=function(e,t){var a=this;window.requestAnimationFrame(function(){a.clearContainer(a.tileContainer),e.cells.forEach(function(e){e.forEach(function(e){e&&a.addTile(e)})}),a.updateScore(t.score),a.updateBestScore(t.bestScore),t.terminated&&(t.over?a.message(!1):t.won&&a.message(!0))})},HTMLActuator.prototype.continueGame=function(){this.clearMessage()},HTMLActuator.prototype.clearContainer=function(e){for(;e.firstChild;)e.removeChild(e.firstChild)},HTMLActuator.prototype.addTile=function(e){var t=this,a=document.createElement("div"),o=document.createElement("div"),i=e.previousPosition||{x:e.x,y:e.y},n=this.positionClass(i),s=["tile","tile-"+e.value,n];e.value>2048&&s.push("tile-super");for(var r=0;r<modes.length;r++)modeStates[modes[r]]&&s.push(modes[r]);this.applyClasses(a,s),o.classList.add("tile-inner"),o.textContent=e.value,e.previousPosition?window.requestAnimationFrame(function(){s[2]=t.positionClass({x:e.x,y:e.y}),t.applyClasses(a,s)}):e.mergedFrom?(s.push("tile-merged"),this.applyClasses(a,s),e.mergedFrom.forEach(function(e){t.addTile(e)})):(s.push("tile-new"),this.applyClasses(a,s)),a.appendChild(o),this.tileContainer.appendChild(a)},HTMLActuator.prototype.applyClasses=function(e,t){e.setAttribute("class",t.join(" "))},HTMLActuator.prototype.normalizePosition=function(e){return{x:e.x+1,y:e.y+1}},HTMLActuator.prototype.positionClass=function(e){return e=this.normalizePosition(e),"tile-position-"+e.x+"-"+e.y},HTMLActuator.prototype.updateScore=function(e){this.clearContainer(this.scoreContainer);var t=e-this.score;if(this.score=e,this.scoreContainer.textContent=this.score,t>0){var a=document.createElement("div");a.classList.add("score-addition"),addClasses(a),a.textContent="+"+t,a.addEventListener("animationend",function(){this.parentNode.removeChild(a)}),this.scoreContainer.appendChild(a)}},HTMLActuator.prototype.updateBestScore=function(e){this.bestContainer.textContent=e},HTMLActuator.prototype.message=function(e){var t=e?"game-won":"game-over",a=e?"You win!":"Game over!";this.messageContainer.classList.add(t),this.messageContainer.getElementsByTagName("p")[0].textContent=a},HTMLActuator.prototype.clearMessage=function(){this.messageContainer.classList.remove("game-won"),this.messageContainer.classList.remove("game-over")},Grid.prototype.empty=function(){for(var e=[],t=0;t<this.size;t++)for(var a=e[t]=[],o=0;o<this.size;o++)a.push(null);return e},Grid.prototype.fromState=function(e){for(var t=[],a=0;a<this.size;a++)for(var o=t[a]=[],i=0;i<this.size;i++){var n=e[a][i];o.push(n?new Tile(n.position,n.value):null)}return t},Grid.prototype.randomAvailableCell=function(){var e=this.availableCells();return e.length?e[Math.floor(Math.random()*e.length)]:void 0},Grid.prototype.availableCells=function(){var e=[];return this.eachCell(function(t,a,o){o||e.push({x:t,y:a})}),e},Grid.prototype.eachCell=function(e){for(var t=0;t<this.size;t++)for(var a=0;a<this.size;a++)e(t,a,this.cells[t][a])},Grid.prototype.cellsAvailable=function(){return!!this.availableCells().length},Grid.prototype.cellAvailable=function(e){return!this.cellOccupied(e)},Grid.prototype.cellOccupied=function(e){return!!this.cellContent(e)},Grid.prototype.cellContent=function(e){return this.withinBounds(e)?this.cells[e.x][e.y]:null},Grid.prototype.insertTile=function(e){this.cells[e.x][e.y]=e},Grid.prototype.removeTile=function(e){this.cells[e.x][e.y]=null},Grid.prototype.withinBounds=function(e){return e.x>=0&&e.x<this.size&&e.y>=0&&e.y<this.size},Grid.prototype.serialize=function(){for(var e=[],t=0;t<this.size;t++)for(var a=e[t]=[],o=0;o<this.size;o++)a.push(this.cells[t][o]?this.cells[t][o].serialize():null);return{size:this.size,cells:e}},window.fakeStorage={_data:{},setItem:function(e,t){return this._data[e]=String(t)},getItem:function(e){return this._data.hasOwnProperty(e)?this._data[e]:void 0},removeItem:function(e){return delete this._data[e]},clear:function(){return this._data={}}},LocalStorageManager.prototype.localStorageSupported=function(){var e="test",t=window.localStorage;try{return t.setItem(e,"1"),t.removeItem(e),!0}catch(a){return!1}},LocalStorageManager.prototype.getBestScore=function(){return this.storage.getItem(this.bestScoreKey)||0},LocalStorageManager.prototype.setBestScore=function(e){this.storage.setItem(this.bestScoreKey,e)},LocalStorageManager.prototype.getGameState=function(){var e=this.storage.getItem(this.gameStateKey);return e?JSON.parse(e):null},LocalStorageManager.prototype.setGameState=function(e){this.storage.setItem(this.gameStateKey,JSON.stringify(e))},LocalStorageManager.prototype.clearGameState=function(){this.storage.removeItem(this.gameStateKey)},LocalStorageManager.prototype.loadBookmarks=function(){if(!this.bookmarksLoaded){var e=this.storage.getItem(this.bookmarksKey);this.bookmarks=e?JSON.parse(e):{};for(var t in this.bookmarks)this.bookmarkKeys.push(t)}this.bookmarksLoaded=!0},LocalStorageManager.prototype.syncBookmarks=function(){this.storage.setItem(this.bookmarksKey,JSON.stringify(this.bookmarks))},LocalStorageManager.prototype.addBookmark=function(e,t){this.bookmarks[e]=JSON.stringify(t),-1===this.bookmarkKeys.indexOf(e)&&this.bookmarkKeys.push(e),this.syncBookmarks()},LocalStorageManager.prototype.loadBookmark=function(e){return JSON.parse(this.bookmarks[e])},LocalStorageManager.prototype.deleteBookmark=function(e){delete this.bookmarks[e],this.bookmarkKeys.splice(this.bookmarkKeys.indexOf(e),1),this.syncBookmarks()},GameManager.prototype.refreshBookmarks=function(){this.storageManager.loadBookmarks();for(var e=function(e){this.popupManager.popups.loadKey.value=e.target.textContent;var t=this.popupManager.popups.load.getElementsByClassName("yes")[0];hasClass(t,"no-click")&&toggleClass("no-click",t)}.bind(this),t=function(e){this.popupManager.popups.saveAs.value=e.target.textContent;var t=this.popupManager.popups.prompt.getElementsByClassName("yes")[0];hasClass(t,"no-click")&&toggleClass("no-click",t)}.bind(this),a=this.storageManager.bookmarkKeys,o=document.getElementsByClassName("bookmark-container"),i=0;i<o.length;i++){var n=o[i];n.innerHTML="";for(var s=0;s<a.length;s++){var r=a[s],l=document.createElement("a");l.innerHTML=r+"<br>",l.onclick="load-popup"===o[i].parentNode.id?e:t,n.appendChild(l)}}this.loaded=!0},GameManager.prototype.saveState=function(){this.popupManager.activate("prompt"),this.refreshBookmarks()},GameManager.prototype.loadState=function(){this.refreshBookmarks(),this.popupManager.activate("load")},GameManager.prototype.restart=function(){this.storageManager.clearGameState(),this.actuator.continueGame(),this.setup()},GameManager.prototype.confirmRestart=function(){this.popupManager.activate("confirm")},GameManager.prototype.keepPlaying=function(){this.keepPlaying=!0,this.actuator.continueGame()},GameManager.prototype.isGameTerminated=function(){return this.over||this.won&&!this.keepPlaying},GameManager.prototype.setState=function(e){this.grid=new Grid(e.grid.size,e.grid.cells),this.score=e.score,this.over=e.over,this.won=e.won,this.keepPlaying=e.keepPlaying,this.actuate()},GameManager.prototype.setup=function(){var e=this.storageManager.getGameState();return e?void this.setState(e):(this.grid=new Grid(this.size),this.score=0,this.over=!1,this.won=!1,this.keepPlaying=!1,this.addStartTiles(),void this.actuate())},GameManager.prototype.addStartTiles=function(){for(var e=0;e<this.startTiles;e++)this.addRandomTile()},GameManager.prototype.addRandomTile=function(){if(this.grid.cellsAvailable()){var e=Math.random()<.9?2:4,t=new Tile(this.grid.randomAvailableCell(),e);this.grid.insertTile(t)}},GameManager.prototype.actuate=function(){this.storageManager.getBestScore()<this.score&&this.storageManager.setBestScore(this.score),this.over?this.storageManager.clearGameState():this.storageManager.setGameState(this.serialize()),this.actuator.actuate(this.grid,{score:this.score,over:this.over,won:this.won,bestScore:this.storageManager.getBestScore(),terminated:this.isGameTerminated()})},GameManager.prototype.serialize=function(){return{grid:this.grid.serialize(),score:this.score,over:this.over,won:this.won,keepPlaying:this.keepPlaying}},GameManager.prototype.prepareTiles=function(){this.grid.eachCell(function(e,t,a){a&&(a.mergedFrom=null,a.savePosition())})},GameManager.prototype.moveTile=function(e,t){this.grid.cells[e.x][e.y]=null,this.grid.cells[t.x][t.y]=e,e.updatePosition(t)},GameManager.prototype.move=function(e){var t=this;if(!this.isGameTerminated()){var a,o,i=this.getVector(e),n=this.buildTraversals(i),s=!1;this.prepareTiles(),n.x.forEach(function(e){n.y.forEach(function(n){if(a={x:e,y:n},o=t.grid.cellContent(a)){var r=t.findFarthestPosition(a,i),l=t.grid.cellContent(r.next);if(l&&l.value===o.value&&!l.mergedFrom){var p=new Tile(r.next,2*o.value);p.mergedFrom=[o,l],t.grid.insertTile(p),t.grid.removeTile(o),o.updatePosition(r.next),t.score+=p.value,2048===p.value&&(t.won=!0)}else t.moveTile(o,r.farthest);t.positionsEqual(a,o)||(s=!0)}})}),s&&(this.addRandomTile(),this.movesAvailable()||(this.over=!0),this.actuate())}},GameManager.prototype.getVector=function(e){var t={0:{x:0,y:-1},1:{x:1,y:0},2:{x:0,y:1},3:{x:-1,y:0}};return t[e]},GameManager.prototype.buildTraversals=function(e){for(var t={x:[],y:[]},a=0;a<this.size;a++)t.x.push(a),t.y.push(a);return 1===e.x&&(t.x=t.x.reverse()),1===e.y&&(t.y=t.y.reverse()),t},GameManager.prototype.findFarthestPosition=function(e,t){var a;do a=e,e={x:a.x+t.x,y:a.y+t.y};while(this.grid.withinBounds(e)&&this.grid.cellAvailable(e));return{farthest:a,next:e}},GameManager.prototype.movesAvailable=function(){return this.grid.cellsAvailable()||this.tileMatchesAvailable()},GameManager.prototype.tileMatchesAvailable=function(){for(var e,t=this,a=0;a<this.size;a++)for(var o=0;o<this.size;o++)if(e=this.grid.cellContent({x:a,y:o}))for(var i=0;4>i;i++){var n=t.getVector(i),s={x:a+n.x,y:o+n.y},r=t.grid.cellContent(s);if(r&&r.value===e.value)return!0}return!1},GameManager.prototype.positionsEqual=function(e,t){return e.x===t.x&&e.y===t.y};var PopupManager=function(e){this.gameManager=e,this.popups={overlay:document.getElementById("overlay"),confirm:document.getElementById("confirm"),prompt:document.getElementById("prompt"),load:document.getElementById("load-popup"),saveAs:document.getElementById("save-as"),loadKey:document.getElementById("load-key"),active:null},toggleClass("hidden",[this.popups.confirm,this.popups.prompt,this.popups.overlay,this.popups.load]),this.terminators={alert:function(){popups.result=!0}.bind(this),confirm:function(e){e&&this.gameManager.restart()}.bind(this),prompt:function(e){e&&this.gameManager.storageManager.addBookmark(this.popups.saveAs.value,this.gameManager.storageManager.getGameState()),this.popups.saveAs.value=""}.bind(this),"load-popup":function(e){e&&this.gameManager.setState(this.gameManager.storageManager.loadBookmark(this.popups.loadKey.value))}.bind(this)},this.popups.saveAs.value="",this.popups.loadKey.value="";for(var t=this.popups.overlay.getElementsByClassName("yes"),a=0;a<t.length;a++)t[a].addEventListener("click",function(e){hasClass(e.target,"no-click")||this.terminate(!0)}.bind(this));for(var o=this.popups.overlay.getElementsByClassName("no"),a=0;a<o.length;a++)o[a].addEventListener("click",function(){this.terminate(!1)}.bind(this));toggleClass("no-click",this.popups.prompt.getElementsByClassName("yes")[0]),this.popups.saveAs.addEventListener("input",function(){var e=this.popups.prompt.getElementsByClassName("yes")[0],t=hasClass(e,"no-click");this.popups.saveAs.value.length>0&&t?toggleClass("no-click",e):0!==this.popups.saveAs.value.length||t||toggleClass("no-click",e)}.bind(this)),this.popups.loadKey.addEventListener("input",function(){var e=this.popups.load.getElementsByClassName("yes")[0],t=hasClass(e,"no-click");-1!==this.gameManager.storageManager.bookmarkKeys.indexOf(this.popups.loadKey.value)&&t?toggleClass("no-click",e):t||toggleClass("no-click",e)}.bind(this))};PopupManager.prototype.activate=function(e){this.popups.active=this.popups[e],"prompt"===e&&this.popups.saveAs.focus();var t=this.popups.active;toggleClass("hidden",[t,this.popups.overlay])},PopupManager.prototype.terminate=function(e){toggleClass("hidden",[this.popups.overlay,this.popups.active]),this.terminators[this.popups.active.id](e),this.popups.active=null},window.requestAnimationFrame(function(){new GameManager(4,KeyboardInputManager,HTMLActuator,LocalStorageManager,PopupManager)});